# tudoh — バーチャルオフィス 企画書

## 概要

Gather の代替となるセルフホスト型バーチャルオフィス。
2D マップ上でアバターを操作し、部屋単位で音声通話ができる。
名前は「集う（つどう）」から。

## 背景

- Gather の料金高騰により代替が必要
- ビデオ通話は Google Meet で十分
- 音声通話 + 2D マップの「居場所がわかる」体験が欲しい

## 要件

### 基本機能

- 2D マップ上でアバターをキーボード操作で移動
- 複数ユーザーのリアルタイム位置同期
- 部屋単位のグループ音声通話（部屋に入ると全員と繋がる）
- 部屋から出ると音声切断

### 規模

- 最大 100 人の同時接続
- 部屋あたりの上限は 20 人程度を想定
- 全体放送モード（1人が喋り、残りは聴くだけ）

### 対象外（Meet で代替）

- ビデオ通話
- 画面共有

## アーキテクチャ

```
┌──────────────┐      WebSocket       ┌──────────────────┐
│              │◄────(位置同期)───────►│                  │
│   ブラウザ    │                      │   Node.js サーバー │
│  (Canvas API) │      WebRTC          │   (Socket.IO)     │
│              │◄──(音声 via SFU)────►│                  │
└──────────────┘                      └────────┬─────────┘
                                               │
                                      ┌────────▼─────────┐
                                      │   LiveKit (SFU)   │
                                      │   Docker で稼働    │
                                      └──────────────────┘
```

### HTTPS / リバースプロキシ

LiveKit の WebRTC は localhost 以外では HTTPS が必須。
本番環境ではリバースプロキシ（Caddy 推奨）を前段に置き、SSL 終端する。

```
インターネット → Caddy (HTTPS) → Node.js (:3000)
                              → LiveKit (:7880)
```

VPS のファイアウォールで LiveKit の UDP ポート (50000-60000) を開放すること。
社内 VPN 等の制限がある環境では TURN サーバーが必要になる場合がある。

## 技術スタック

| レイヤー | 技術 | 理由 |
|---------|------|------|
| フロント描画 | Canvas API | ゲームエンジンは過剰。描画要件が軽量なので素の Canvas で十分 |
| フロント音声 | LiveKit Client SDK | SFU クライアントを自前実装しなくて済む |
| バックエンド | Node.js + Socket.IO | リアルタイム位置同期。WebSocket 扱いやすい |
| SFU | LiveKit (セルフホスト) | OSS、Docker 一発、音声のみなら軽量 |
| 言語 | TypeScript | フロント・バック共通 |

### WASM は不要

ボトルネックがすべて I/O（描画は GPU、音声は WebRTC、通信はネットワーク）であり、CPU バウンドな処理がないため。

### Phaser.js を採用しない理由

- バンドルサイズが大きい（~1MB）
- ゲームループが常時 60fps で回る（バーチャルオフィスでは過剰）
- 名前ラベル等の DOM 表現が逆に面倒
- 必要な機能（タイル描画・矩形衝突判定）は Canvas API で数十行で書ける

## 位置同期の設計

### tick rate

- サーバーは **10Hz**（100ms 間隔）で各クライアントの位置をブロードキャスト
- クライアントは入力のたびにサーバーへ自分の位置を送信（キー押下中のみ）
- サーバー側で全ユーザーの最新位置を保持し、tick ごとにまとめて配信

### 差分送信

- 位置が変わったユーザーのみ配信（静止中のユーザーは省略）
- 新規接続時のみフルステートを送信

### 再接続

- Socket.IO の自動再接続を利用
- 再接続時にサーバーからフルステートを再送
- LiveKit も自動再接続をサポート

## 音声通話の方式: SFU

```
各ユーザー → 1本だけサーバーに送信 → サーバーが同じ部屋の他メンバーに転送
```

- クライアントの負担が軽い（送信 1 本）
- サーバーはミックスせず転送のみなので軽量
- 100 人が 10 部屋に分かれれば、帯域は約 45 Mbps（VPS 1 台で余裕）

## スケーラビリティ設計

Opus 音声 ~50kbps/ストリーム前提。

| シナリオ | 送信帯域 | 判定 |
|---------|---------|------|
| 10 部屋 × 10 人 | ~45 Mbps | 余裕 |
| 5 部屋 × 20 人 | ~95 Mbps | OK |
| 全体放送 (1→99) | ~5 Mbps | 余裕 |
| 1 部屋に 100 人全員 | ~495 Mbps | 非推奨 → 部屋上限で制御 |

## マップ定義

マップは JSON で定義する。タイルベースの 2D グリッド。

```jsonc
{
  "tileSize": 32,       // 1タイルのピクセルサイズ
  "width": 40,          // マップ幅（タイル数）
  "height": 30,         // マップ高さ（タイル数）
  "tiles": [[...]],     // 2D 配列。0=床, 1=壁
  "rooms": [
    {
      "id": "room-a",
      "name": "会議室A",
      "x": 5, "y": 5,   // 左上タイル座標
      "w": 6, "h": 4,   // 幅・高さ（タイル数）
      "maxUsers": 20
    }
  ],
  "spawns": [            // 初期出現位置の候補
    { "x": 20, "y": 15 }
  ]
}
```

部屋の出入り判定はアバターのタイル座標が部屋の矩形 (x, y, w, h) 内にあるかの AABB 判定。

## ホスティング

- セルフホスト前提
- VPS 1 台構成（Node.js + LiveKit を Docker Compose で）
- 音声のみなので低スペックで運用可能
- スケール時は LiveKit を別サーバーに分離可能

## MVP スコープ

1. 2D マップ表示 + アバター移動
2. WebSocket による複数ユーザーの位置同期（10Hz tick、差分送信）
3. 部屋エリアの定義（JSON マップ）
4. 部屋に入ったら LiveKit の音声ルームに自動接続
5. 部屋から出たら自動切断
6. 認証（名前入力のみ。内部的に UUID で識別）

## 将来的な拡張候補

- マップエディタ（GUI）
- リアクション（絵文字等）
- ステータス表示（離席中、会議中など）
- 全体放送モード
- オブジェクトインタラクション（ホワイトボード等）
